---
title: Route Patch
---

## Description

The `routePatch` plugin allows users to directly apply patches to one or more Envoy routes corresponding to a VirtualService or HTTPRoute. Note that the TargetRef of the FilterPolicy configured with the `routePatch` plugin can only be a VirtualService or HTTPRoute.

## Attribute

|        |              |
|--------|--------------|
| Type   | General      |
| Order  | Inner        |
| Status | Experimental |

## Configuration

Please refer to the corresponding [Envoy documentation](https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-msg-config-route-v3-route).

## Usage

Suppose we have the following HTTPRoute attached to `localhost:10000`, and a backend server listening on port `8080`:

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: default
spec:
  parentRefs:
  - name: default
  rules:
  - matches:
    - path:
        type: Exact
        value: /reply
    backendRefs:
    - name: backend
      port: 8080
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: backend
      port: 8080
```

By applying the following configuration, we can interrupt requests to `http://localhost:10000/` with a custom response:

```yaml
apiVersion: htnn.mosn.io/v1
kind: FilterPolicy
metadata:
  name: policy
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: default
  filters:
    routePatch:
      config:
        directResponse:
          status: 403
```

At this point, the two routes generated by HTTPRoute `default` will both have the direct_response field:

```yaml
routes:
    - directResponse:
        status: 403
      match:
        caseSensitive: true
        path: /reply
      name: e2e.default.0
      ...
    - directResponse:
        status: 403
      match:
        caseSensitive: true
        prefix: /
      name: e2e.default.1
      ...
```

We can also specify the names of specific routes so that the modifications only affect specific routes. In the configuration below, only the route named `last` will be patched:

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: vs
  namespace: istio-system
spec:
  gateways:
  - default
  hosts:
  - "default.local"
  http:
  - match:
    - uri:
        prefix: /echo
    route:
    - destination:
        host: backend
        port:
          number: 8080
  - match:
    - uri:
        prefix: /
    name: last
    route:
    - destination:
        host: backend
        port:
          number: 8080
---
apiVersion: htnn.mosn.io/v1
kind: FilterPolicy
metadata:
  name: policy
  namespace: istio-system
spec:
  targetRef:
    group: networking.istio.io
    kind: VirtualService
    name: vs
    sectionName: last
  filters:
    routePatch:
      config:
        directResponse:
          status: 403
```
